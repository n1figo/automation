import pandas as pd
from datetime import datetime
from pathlib import Path

def markdown_table_to_excel(markdown_text: str, output_dir: str = "output"):
    """마크다운 테이블을 Excel 파일로 변환"""
    
    # 출력 디렉토리 생성
    output_dir = Path(output_dir)
    output_dir.mkdir(exist_ok=True)
    
    # 마크다운 테이블 파싱
    lines = [line.strip() for line in markdown_text.split('\n') if line.strip()]
    
    # 헤더 추출
    headers = [h.strip() for h in lines[0].split('|')[1:-1]]
    
    # 데이터 행 추출 (구분선 제외)
    rows = []
    for line in lines[2:]:  # 첫 번째 구분선 이후의 라인들
        if not line.startswith('|-'):  # 구분선 제외
            row_data = [cell.strip() for cell in line.split('|')[1:-1]]
            rows.append(row_data)
    
    # DataFrame 생성
    df = pd.DataFrame(rows, columns=headers)
    
    # 파일명 생성 (현재 시간 포함)
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_path = output_dir / f"table_data_{timestamp}.xlsx"
    
    # Excel 파일로 저장
    with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
        df.to_excel(writer, sheet_name='Table Data', index=False)
        
        # 열 너비 자동 조정
        worksheet = writer.sheets['Table Data']
        for idx, col in enumerate(df.columns):
            max_length = max(
                df[col].astype(str).apply(len).max(),
                len(str(col))
            )
            worksheet.column_dimensions[chr(65 + idx)].width = min(max_length + 2, 50)
    
    print(f"\nExcel 파일이 생성되었습니다: {output_path}")
    return output_path

# 마크다운 테이블 데이터
markdown_table = """| 보장명 | 지급사유 | 지급금액 |
|--------|----------|----------|
| 2대질환 항암조영술 검사지원비 (급여, 연간1회한) [갱신계약] | 보험기간 중에 의료법 제3조(의료기관)에서 정한 국내의 병원이나 의원 또는 국외의 의료관련법에서 정한 의료기관의 의사 자격증을 가진 자에 의하여 내려진 "2대질환"의 진단 및 치료를 위한 필요소견을 토대로 "2대질환 항암조영술(급여)"을 받은 경우(1회 이내 지급(연간)) | 가입금액 (연간1회한) |
| 중증갑상선암진단비(갑상선암) | 중증갑상선암보장개시일*) 이후에 중증갑상선암으로 진단확정된 경우 | 가입금액 (최초 1회한) |
| 간병인사용 질병입원일당 (1일이상)(요양병원 제외) | 질병으로 요양병원을 제외한 병원 또는 의원에 입원하여 치료를 받으며 간병인을 사용하여 실질적으로 간병서비스를 이용한 경우(1일 입원당 180일 한도) | 가입금액 (1일당) (단, 간병인 사용금액이 1일당 7만원 미만인 경우 : 가입금액의 50%) |
| 간병인사용 질병입원일당 (1일이상)(요양병원 제외) [갱신계약] | 질병으로 요양병원을 제외한 병원 또는 의원에 입원하여 치료를 받으며 간병인을 사용하여 실질적으로 간병서비스를 이용한 경우(1일 입원당 180일 한도) | 가입금액 (1일당) |
| 간병인사용 질병입원일당 (1일이상)(요양병원) | 질병으로 요양병원에 입원하여 치료를 받으며 간병인을 사용하여 실질적으로 간병서비스를 이용한 경우(1일 입원당 180일 한도) | 가입금액 (1일당) |
| 간병인사용 질병입원일당 (1일이상)(요양병원) [갱신계약] | 질병으로 요양병원에 입원하여 치료를 받으며 간병인을 사용하여 실질적으로 간병서비스를 이용한 경우(1일 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당(1-180일) | 질병으로 요양병원을 제외한 병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당(1-180일) [갱신계약] | 질병으로 요양병원을 제외한 병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (중환자실, 1-180일) | 질병으로 중환자실에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (중환자실, 1-180일) [갱신계약] | 질병으로 중환자실에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (상급종합병원, 1-180일) | 질병으로 상급종합병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (상급종합병원, 1-180일) [갱신계약] | 질병으로 상급종합병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 180일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당(1-60일) | 질병으로 요양병원을 제외한 병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당(1-60일) [갱신계약] | 질병으로 요양병원을 제외한 병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (중환자실, 1-60일) | 질병으로 중환자실에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (중환자실, 1-60일) [갱신계약] | 질병으로 중환자실에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (상급종합병원, 1-60일) | 질병으로 상급종합병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 간호·간병통합서비스 질병입원일당 (상급종합병원, 1-60일) [갱신계약] | 질병으로 상급종합병원에 입원하여 치료를 받으며 간호·간병통합서비스를 사용한 경우(1회 입원당 60일 한도) | 가입금액 (1일당) |
| 종합병원질병입원일당 (1일이상) | 질병으로 1일 이상 종합병원에 입원하여 치료시(1회 입원당 180일 한도) | 가입금액(1일당) |"""

# 함수 실행
output_file = markdown_table_to_excel(markdown_table)